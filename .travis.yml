language: bash

env:
    - DOCKER_COMPOSE_VERSION=1.24.0

cache:
    directories:
        - $HOME/.composer/cache
        - $HOME/.sonar

services:
    - docker

before_install:
    # Upgrade Docker (fixes ls: cannot access '.': Operation not permitted)
    - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
    - sudo apt-get update
    - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
    # Install docker-compose
    - sudo rm /usr/local/bin/docker-compose
    - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
    - chmod +x docker-compose
    - sudo mv docker-compose /usr/local/bin

install:
    - cp .env .env.local
    - docker-compose up -d php
    - make composer-install

script:
    - make test
    - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then docker run -v $PWD:/usr/src -v $HOME/.sonar:/root/.sonar -e SONAR_TOKEN=$SONAR_TOKEN newtmitch/sonar-scanner:4.0 ; fi

deploy:
    -   provider: heroku
        api_key:
            secure: N1zHPTFpF7pdYh3dUkgXmQb0bJj4qjIc89HRVQF4TzZwZYc4/a60svyaQX61fje1lLC9ezsW+iM7eAuq+ptsyfa3bNAlzXKrTgqUmmaIoAeIlEF3i5bGiHjD8PpByHqNy4nbOqKYy9Uym/yKiW7qutegt7lktFOA9G40xpVs9ICenX9H5MFVGRDfTkzQQ5ZPfF9r6hhysMzLVnuLPBlfcszRlWVixcZ6DMzHJCXImxiHqySAErAhPVzQPJH8cPTaidslhTQNfL+N5amwB67WzH0iw3Dzjs0ICJgQlXdkIWAi8gI6OFIdeNuzcWhCIFg29z6GIbP5qmEKSF2PIqsmIQqtYa71JEhSdlCstaxcaHbX9sEKz3+7G9hFP0mXt+JDWwcr3LBt3wQD4+jkRJU2dM76XbkGJW3AwewARzmOFOJrPgF7JCzAQ344Z2VvsNyWdl5idQDPwg5tMXbWJ8nKr7ozH4EyQWs8snaKsEiM2uxrSdgmgFcwKrajnAjFV8B3BNhYHQRYDw3dcvSFSWmAvxkeq6A2h7SmNJxRW6VVICoMeQYxaB4Go+SPZeWqKoL2pAnNug8QD2E7a7+JNy6rWqYlYlLC6xK9djR2Nz4wM+ONYK17mffpOOlcoJHursIzvssbwiv+c8T16ei3riKit0pu2XXriXZ3nzxug3CdRzY=
        app: okty-server
        on:
            repo: Okty-io/okty-server
            branch: master
    -   provider: heroku
        api_key:
            secure: N1zHPTFpF7pdYh3dUkgXmQb0bJj4qjIc89HRVQF4TzZwZYc4/a60svyaQX61fje1lLC9ezsW+iM7eAuq+ptsyfa3bNAlzXKrTgqUmmaIoAeIlEF3i5bGiHjD8PpByHqNy4nbOqKYy9Uym/yKiW7qutegt7lktFOA9G40xpVs9ICenX9H5MFVGRDfTkzQQ5ZPfF9r6hhysMzLVnuLPBlfcszRlWVixcZ6DMzHJCXImxiHqySAErAhPVzQPJH8cPTaidslhTQNfL+N5amwB67WzH0iw3Dzjs0ICJgQlXdkIWAi8gI6OFIdeNuzcWhCIFg29z6GIbP5qmEKSF2PIqsmIQqtYa71JEhSdlCstaxcaHbX9sEKz3+7G9hFP0mXt+JDWwcr3LBt3wQD4+jkRJU2dM76XbkGJW3AwewARzmOFOJrPgF7JCzAQ344Z2VvsNyWdl5idQDPwg5tMXbWJ8nKr7ozH4EyQWs8snaKsEiM2uxrSdgmgFcwKrajnAjFV8B3BNhYHQRYDw3dcvSFSWmAvxkeq6A2h7SmNJxRW6VVICoMeQYxaB4Go+SPZeWqKoL2pAnNug8QD2E7a7+JNy6rWqYlYlLC6xK9djR2Nz4wM+ONYK17mffpOOlcoJHursIzvssbwiv+c8T16ei3riKit0pu2XXriXZ3nzxug3CdRzY=
        app: okty-server-dev
        on:
            repo: Okty-io/okty-server
            branch: dev
